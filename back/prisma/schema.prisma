generator client {
  provider = "prisma-client"
  output   = "../lib/prisma"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./docs/erd.pdf"
}

datasource db {
  provider = "postgresql"
}

enum Rol {
  SUPER
  ADMIN
  USER
}

enum EstadoOp {
  BORRADOR
  CONFIRMADA
  ANULADA
}

enum TCategoria {
  FAMILIA
  MADRE
  HIJA
}


// Usuarios y empresas
model Usuarios {
  idUsuario     Int      @id @default(autoincrement())
  username      String   @unique
  email         String   @unique
  password      String
  nombre        String
  activo        Boolean  @default(false)
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  rol           Rol      @default(USER)

  cliente      Clientes?
}

model Empresas {
  idEmpresa  Int    @id @default(1)  // fijamos la PK en 1
  nombre     String
  email      String?

  calle      String   @default("")
  numero     String?
  ciudad     String   @default("")
  provincia  String   @default("")
  codigoPostal String @default("")
  pais       String   @default("")
  contacto   String?
  activo     Boolean  @default(true)
}

// Clientes
model Clientes {
  idCliente  Int       @id @default(autoincrement())
  idUsuario     Int      @unique   // FK a Usuario
  usuario       Usuarios  @relation(fields: [idUsuario], references: [idUsuario])

  nombre     String
  email      String?
  calle      String   @default("")
  numero     String?
  ciudad     String   @default("")
  provincia  String   @default("")
  codigoPostal String @default("")
  pais       String   @default("")
  contacto   String?
  activo     Boolean  @default(true)

  historial Operaciones[]
}

// Categorías
model Categorias {
  idCategoria      Int         @id @default(autoincrement())
  nombre           String
  descripcion      String?
  icono            String?
  tipo             TCategoria
  activo           Boolean  @default(true)
  idCategoriaPadre Int?
  categoriaPadre   Categorias? @relation("Jerarquia", fields: [idCategoriaPadre], references: [idCategoria])
  subcategorias    Categorias[] @relation("Jerarquia")

  productos        Productos[]

  @@index([tipo])
  @@index([idCategoriaPadre])
}

// Productos

model Productos {
  idProducto   Int         @id @default(autoincrement())
  nombre       String
  descripcion  String?
  activo       Boolean     @default(true)

  precios             Decimal @default(0.0)
  stock               Int @default(0)

  idCategoria  Int
  categoria    Categorias  @relation(fields: [idCategoria], references: [idCategoria])

  // Relaciones existentes
  imagenes            ProductoImagenes[]
  operacionesDetalle  OperacionDetalle[]
  comandasProductos   ComandaProductos[]
  
}

// Imágenes de productos
model ProductoImagenes {
  idImagen    Int       @id @default(autoincrement())
  idProducto  Int
  producto    Productos @relation(fields: [idProducto], references: [idProducto])
  url         String
  alt         String?
  orden       Int       @default(1)
  principal   Boolean   @default(false)
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
}


// Operaciones y detalle
model Operaciones {
  idOperacion  Int           @id @default(autoincrement())
  estado       EstadoOp
  total        Decimal
  // La FK debe ser opcional para permitir el modo anónimo
  idCliente    Int?
  cliente      Clientes?     @relation(fields: [idCliente], references: [idCliente])

  createdAt    DateTime      @default(now())
  confirmedAt  DateTime?
  operacionesDetalle OperacionDetalle[]
  comanda          Comanda?
}
// Detalles de operaciones
model OperacionDetalle {
  idDetalle      Int        @id @default(autoincrement())
  idOperacion    Int
  idProducto     Int
  cantidad       Decimal
  precioUnitario Decimal
  subtotal       Decimal
  operacion      Operaciones @relation(fields: [idOperacion], references: [idOperacion])
  producto       Productos   @relation(fields: [idProducto], references: [idProducto])
}

// Cocineros y comandas

enum EstadoComanda {
  PENDIENTE    // Nadie ha reclamado ningún item
  SINCOCINA   // Al menos un item ha sido reclamado por un cocinero pero no se ha empezado a preparar
  FINALIZADA   // Todos los items están en SERVIDO
  ENTREGADA    // El cliente ya recibió el pedido (Estado final manual)
  ANULADA      // Comanda anulada (Estado final manual)
}

// --- MODELOS ---

model Cocinero {
  idCocinero  Int    @id @default(autoincrement())
  nombre      String
  activo      Boolean   @default(true)
  
  comandasProductos  ComandaProductos[]

  createdAt DateTime  @default(now())
}

model Comanda {
  id           Int        @id @default(autoincrement())
  
  // Referencia al origen (Sistema de Ventas)
  idOperacion  Int           @unique
  operacion    Operaciones @relation(fields: [idOperacion], references: [idOperacion])
  
  // El estado es DERIVADO pero se persiste para consultas eficientes
  estado       EstadoComanda @default(PENDIENTE)

  productos        ComandaProductos[]
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([estado])
}

model ComandaProductos {
  id           Int     @id @default(autoincrement())
  idComanda    Int

  idProducto   Int
  producto     Productos   @relation(fields: [idProducto], references: [idProducto])

  pedido     Int
  servido    Int @default(0)
  
  idCocinero   Int?       
  cocinero     Cocinero?     @relation(fields: [idCocinero], references: [idCocinero])
  
  comanda      Comanda    @relation(fields: [idComanda], references: [id], onDelete: Cascade)

  @@index([idProducto])
  @@index([idComanda])
  @@index([idCocinero])
}